<?xml version="1.0" encoding="utf-8"?>
<kiln:root xmlns:h="http://apache.org/cocoon/request/2.0"
           xmlns:xi="http://www.w3.org/2001/XInclude"
           xmlns:kiln="http://www.kcl.ac.uk/artshums/depts/ddh/kiln/ns/1.0"
           xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

  <xsl:param name="base-uri" />
  <xsl:param name="query-string" />
  <xsl:param name="rdf-facet-lookup-fields" />
  <xsl:param name="search-lemma" />

  <!-- Imports stylesheet to convert Solr results into HTML. -->
  <xsl:import href="cocoon://_internal/template/xsl/stylesheets/solr/results-to-html.xsl" />

  <!-- Variables defining search parameter values. -->
  <xsl:variable name="q_value" select="normalize-space(/aggregation/h:request/h:requestParameters/h:parameter[@name='q']/h:value)" />
  <xsl:variable name="df_value" select="normalize-space(/aggregation/h:request/h:requestParameters/h:parameter[@name='df']/h:value)" />

  <kiln:parent>
    <xi:include href="base.xml" />
  </kiln:parent>

  <kiln:child>
    <kiln:block name="title">
      <kiln:super />
      <xsl:text>Search</xsl:text>
    </kiln:block>

    <kiln:block name="css">
      <kiln:super />
      <link href="{$kiln:assets-path}/styles/jquery-ui/all.css"
            rel="stylesheet" type="text/css" />
    </kiln:block>

    <kiln:block name="page-heading">
      <kiln:super />
      <xsl:text>Search</xsl:text>
    </kiln:block>

    <kiln:block name="content">
      <div class="row">
        <div class="large-4 columns">
          <form action="." id="search-form" method="get">
            <input id="write" name="q" placeholder="Search terms" type="search">
              <xsl:attribute name="value">
                <xsl:value-of select="$q_value" />
              </xsl:attribute>
            </input>
            <xsl:if test="$search-lemma">
              <label>
                <input name="df" type="checkbox" value="lemmatised_text">
                  <xsl:if test="$df_value = 'lemmatised_text'">
                    <xsl:attribute name="checked">checked</xsl:attribute>
                  </xsl:if>
                </input>
                <xsl:text> Search lemmatised text</xsl:text>
              </label>
            </xsl:if>
            
            <label>
              <p>
              <a href="{kiln:url-for-match('local-search', ($language), 0)}"><xsl:text>Reset search</xsl:text></a>
              </p>
            </label>
            
            <h4>Date <span id="date-slider-label"></span></h4>
            <div id="date-slider-widget" data-range-min="500" data-range-max="1500" data-value-min="500" data-value-max="1500" data-step="25" data-label-prefix="" data-label-suffix="A.D." data-field-name="origin_date" />
          </form>
          <!-- List of currently applied facets. -->
          <xsl:apply-templates mode="search-results" select="/aggregation/response/lst[@name='responseHeader']/lst[@name='params']/*[@name='fq']" />
          <!-- List available facets. -->
          <xsl:apply-templates select="/aggregation/response/lst[@name='facet_counts']/lst[@name='facet_fields']"
                               mode="search-results" />
        </div>
        <div class="large-8 columns">
          <xsl:apply-templates select="/aggregation/response/result"
                               mode="search-results" />
        </div>
      </div>
      
      <div class="row">
        <div type="map"><div id="map" style="height:320px; margin-bottom:4em">
          <link href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" rel="stylesheet" type="text/css"/>
          <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
          <script type="text/javascript">
            var mapBoxBackground = new ol.Map({
            target: 'map',
            layers: [
            new ol.layer.Tile({
            source: new ol.source.XYZ({
            url: "https://{a-c}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png" +
            "?apikey=edd389ca6c8f43068da70d6664fb48fc"
            })
            })
            ],
            sphericalMercator: true,
            wrapDateLine: true,
            transitionEffect: 'resize',
            buffer: 1,
            numZoomLevels: 13,
            view: new ol.View({
            center: ol.proj.fromLonLat([10.335706471960295, 43.885173623043144]),
            zoom: 8
            })
            });
          </script>
          <p style="text-align:center; font-size:12px; margin-top:1em">© <a href='https://openlayers.org/'>OpenLayers</a> 
            | Data © <a href='https://openlayers.org/'>OpenLayers</a> contributors, CC-BY-SA 
            | Tiles and Data © 2013 <a href='https://openlayers.org/'>OpenLayers</a> CC-BY-NC 3.0</p>
        </div></div>
      </div>
    </kiln:block>

    <kiln:block name="end-js">
      <kiln:super />
      <script src="{$kiln:assets-path}/scripts/jquery-ui.min.js" />
      <script src="{$kiln:assets-path}/scripts/URI.js" />
      <script src="{$kiln:assets-path}/scripts/slider.js" />
      <script>
      $(document).ready(function() {
        var form = $("#search-form"),
            widget = $("#date-slider-widget"),
            label = $("#date-slider-label"),
            inputs = ["q"],
            checked_inputs = ["df"];
        prepare_form(form, widget, inputs, checked_inputs);
        setup_slider(widget, label);
      });
      </script>
      
      <!-- The following script enables to show or hide the facets items and the Greek keyboard. -->
      <script>
        function toggle_visibility(id) {
        var e = document.getElementById(id);
        if(e.style.display == 'block')
        e.style.display = 'none';
        else
        e.style.display = 'block';
        }
      </script>
      
    </kiln:block>
  </kiln:child>

</kiln:root>
